= OpenShift Telco RAN Reference Design Specification
include::../_attributes.adoc[]

== Lab Overview

This lab introduces the Telco RAN Reference Design Specification and demonstrates how to validate and enforce compliance using the cluster-compare plugin. You'll learn to detect configuration drift against telco-specific requirements and remediate misconfigurations to ensure optimal 5G workload performance.

=== Learning Objectives

By completing this lab, you will be able to:

* Understand the Telco RAN DU Reference Design Specification requirements
* Install and configure the cluster-compare plugin for compliance validation
* Detect configuration drift against telco reference standards
* Apply corrective configurations to achieve RDS compliance
* Verify cluster compliance using automated validation tools

=== Reference Documentation

* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/scalability_and_performance/telco-ran-du-ref-design-specs#telco-ref-design-overview_telco-ran-du[Telco RAN DU Reference Design Specifications]

== Understanding Telco RAN Reference Design

=== Telco RDS Overview

The Telco RAN DU Reference Design Specification (RDS) defines the recommended configuration for OpenShift clusters hosting 5G Radio Access Network workloads on commodity hardware. This specification ensures:

* *Reliable Performance*: Consistent, predictable behavior for real-time 5G workloads
* *Tested Configurations*: Validated settings based on extensive field testing
* *Supported Standards*: Red Hat-supported configurations for production deployments
* *Optimized Resource Usage*: Efficient utilization of compute, memory, and network resources

Key RDS components include:

* *Machine Configuration*: Kernel parameters, systemd services, and OS-level tuning
* *Performance Profiles*: CPU isolation, NUMA topology awareness, and real-time scheduling
* *Network Configuration*: SR-IOV, DPDK, and high-performance networking

=== Setup Machine Config Pool

For this exercise and the following ones, we'll create a new node and MachineConfig Pool called "workshop" to avoid waiting too long during the changes we'll make to the nodes.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Scale up 1 nodes (5min)
MACHINESET=$(oc get machinesets.machine.openshift.io -n openshift-machine-api -o name | head -1)
echo "Using machineset: $MACHINESET"
oc scale $MACHINESET -n openshift-machine-api --replicas=5
oc get machines.machine.openshift.io -n openshift-machine-api
oc get nodes

# Label a worker node for the new MCP
NODE=$(oc get nodes -l node-role.kubernetes.io/worker --sort-by=.metadata.creationTimestamp | tail -1 | awk '{print $1}')
echo "Selected node: $NODE"

# Add label
oc label node "$NODE" node-role.kubernetes.io/workshop="" --overwrite

# Verify node labeling
oc get node "$NODE" --show-labels | grep workshop

# Create the MCP
cd lab-materials/01-telco-rds
oc apply -f machine_config_pool.yaml

# Verify new MCP is created and updated
oc get mcp
----

[NOTE]
====
Expected output (takes 2-3 minutes):

[source,bash]
----
oc get mcp workshop 
NAME       CONFIG                                               UPDATED   UPDATING   DEGRADED   MACHINECOUNT   READYMACHINECOUNT   UPDATEDMACHINECOUNT   DEGRADEDMACHINECOUNT   AGE
workshop   rendered-workshop-a34756497573708d31cb436f11ea8dee   True      False      False      1              1                   1                     0                      3m6s
----

The MCP is healthy when `UPDATED=True`, `UPDATING=False`, and `DEGRADED=False`. This indicates the machine configuration has been successfully applied to all nodes in the pool.
====


=== Cluster-Compare Plugin Purpose

The cluster-compare plugin is an OpenShift CLI tool that:

* Compares cluster configuration against reference specifications
* Reports configuration differences and compliance gaps
* Suppresses expected variations using configurable validation rules
* Provides actionable remediation guidance for non-compliant configurations

== Exercise 1: Installing the Cluster-Compare Plugin

=== Plugin Installation Process

Navigate to the lab exercise directory and install the cluster-compare plugin:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----

# Create a container for the cluster-compare image
podman create --name cca quay.io/jclaret/openshift4/kube-compare-artifacts-rhel9:latest

# Copy the cluster-compare plugin to a directory in your PATH
podman cp cca:/usr/share/openshift/linux_amd64/kube-compare.rhel9 kubectl-cluster_compare

# Make the plugin executable and move to system PATH
chmod +x kubectl-cluster_compare
sudo mv kubectl-cluster_compare /usr/local/bin/kubectl-cluster_compare

# Clean up the temporary container
podman rm cca
----

=== Verify Plugin Installation

Confirm the cluster-compare plugin is properly installed and accessible:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Verify plugin installation and view available options
oc cluster-compare -h
----

Expected output should display the plugin help information and available command options.

== Exercise 2: Extracting Reference Configuration

=== Reference Bundle Extraction

Extract the telco RAN reference configuration bundle for comparison:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Pull the ZTP site generator image containing reference configurations
podman pull quay.io/jclaret/openshift4/ztp-site-generate-rhel8:v4.18

# Create output directory for extracted reference content
mkdir -p ./out

# Extract reference bundle from the container image
podman run --log-driver=none --rm \
  quay.io/jclaret/openshift4/ztp-site-generate-rhel8:v4.18 \
  extract /home/ztp --tar | tar x -C ./out
----

This creates a directory structure `out/reference/...` containing the complete telco RAN reference configuration.

=== Creating Minimal Validation Scope

For this lab exercise, we'll use a simplified metadata file focusing on essential configuration:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Copy the simplified metadata file for lab exercise
cp metadata_workshop.yaml out/reference/metadata_workshop.yaml
cp 06-kdump-workshop.yaml out/source-crs/extra-manifest

# Review the metadata content
cat out/reference/metadata_workshop.yaml
----

== Exercise 3: Detecting Configuration Drift

=== Initial Compliance Assessment

Run the cluster-compare plugin to identify configuration gaps against the RDS requirements:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Execute compliance comparison against simplified metadata
oc cluster-compare -r out/reference/metadata_workshop.yaml
----

=== Analysis Results

The cluster-compare output will likely show non-compliant configurations.

Example expected output:
[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc cluster-compare -r out/reference/metadata_workshop.yaml

Summary
CRs with diffs: 0/0
CRs in reference missing from the cluster: 1
required-machine-config:
  machine-config:
    Missing CRs:
    - required/machine-config/kdump/06-kdump-worker.yaml
      Description:
        https://docs.openshift.com/container-platform/4.18/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-machine-configuration_ran-ref-design-components
No CRs are unmatched to reference CRs
Metadata Hash: dfdcc0a98940b59b6767a0c016e3a858a512df172cd37cbb11d7cf1ed9f83d40
No patched CRs
----

== Exercise 4: Resolving Configuration Drift

**ðŸŽ¯ YOUR MISSION**: The cluster-compare output above shows a **configuration drift problem**. Your task is to:

1. **Understand the problem** - What exactly is missing and why is it critical?
2. **Find the solution** - Locate the missing configuration file and apply it
3. **Verify the fix** - Confirm the cluster is now compliant

**Time Limit**: 10-15 minutes of investigation before checking the solution
====

[TIP]
====
ðŸ’¡ **Investigation Hints**:

**Finding the missing file:**
```bash
# Look for kdump-related files in the extracted bundle
find out/source-crs/ -name "*kdump*" -type f

# Check the extra-manifest directory specifically
ls -la out/source-crs/extra-manifest/

# Look for files that might contain the missing configuration
find out/ -name "*06-kdump*" -type f
```
====

**Understanding the problem:**
- kdump is a kernel crash dumping mechanism
- Required for telco RAN to capture crash dumps for root cause analysis
- Missing configuration means crash dumps won't be captured during kernel panics


=== Solution Implementation

[%collapsible]
.Click to reveal the solution
====
If you've completed your investigation or need guidance, here's the solution:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Apply RDS configuration example
oc apply -f ./out/source-crs/extra-manifest/06-kdump-workshop.yaml

# Watch the rollout
oc get mcp workshop

# Verify compliance (run after rollout completes)
oc cluster-compare -r out/reference/metadata_workshop.yaml
----

==== Monitor Drain Progress

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Check which node is currently being drained
oc get nodes

# View detailed events for the problematic node
oc describe node <node-name> | grep -A 20 Events

# Check for pods blocking the drain
oc logs -n openshift-machine-config-operator deployment/machine-config-controller -f

# Delete blocking pods
oc delete pod <pod_name> -n <namespace> --force

# Change PDB minAvailable from 1 to 0 - HyperShift Hosted Cluster
oc patch pdb etcd -n local-cluster-development -p '{"spec":{"minAvailable":0}}'
oc patch pdb kube-apiserver -n local-cluster-development -p '{"spec":{"minAvailable":0}}'
oc patch pdb oauth-openshift -n local-cluster-development -p '{"spec":{"minAvailable":0}}'
oc patch pdb openshift-apiserver -n local-cluster-development -p '{"spec":{"minAvailable":0}}'
oc patch pdb openshift-oauth-apiserver -n local-cluster-development -p '{"spec":{"minAvailable":0}}'
----
====

=== Verification

Wait for all Machine Config Pools to show `UPDATED=True` and `UPDATING=False`, then verify complete compliance.

Expected successful output:
[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
Summary
CRs with diffs: 0/1
No validation issues with the cluster
No CRs are unmatched to reference CRs
Metadata Hash: 325a28a44f8a057b472c54d479989514ad17251be45d4a628682bc770576a57e
No patched CRs
----
====

== Lab Summary

This lab demonstrated the critical importance of maintaining telco RAN RDS compliance for 5G workload reliability. Key achievements include:

* Understanding telco-specific OpenShift configuration requirements
* Installing and using the cluster-compare plugin for automated compliance validation
* Detecting and remediating configuration drift using Machine Config resources
* Verifying successful compliance remediation through automated testing

== Additional Resources

* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/scalability_and_performance/telco-ran-du-ref-design-specs[Complete Telco RAN DU Reference Design Specification]
