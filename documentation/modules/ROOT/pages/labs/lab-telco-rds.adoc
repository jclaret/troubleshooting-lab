= OpenShift Telco RAN Reference Design Specification
include::../_attributes.adoc[]

== Lab Overview

This lab introduces the Telco RAN Reference Design Specification and demonstrates how to validate and enforce compliance using the cluster-compare plugin. You'll learn to detect configuration drift against telco-specific requirements and remediate misconfigurations to ensure optimal 5G workload performance.

=== Learning Objectives

By completing this lab, you will be able to:

* Understand the Telco RAN DU Reference Design Specification requirements
* Install and configure the cluster-compare plugin for compliance validation
* Detect configuration drift against telco reference standards
* Apply corrective configurations to achieve RDS compliance
* Verify cluster compliance using automated validation tools

=== Reference Documentation

* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/scalability_and_performance/telco-ran-du-ref-design-specs#telco-ref-design-overview_telco-ran-du[Telco RAN DU reference design specification]

== Understanding Telco RAN Reference Design

=== Telco RDS Overview

The Telco RAN DU Reference Design Specification (RDS) defines the recommended configuration for OpenShift clusters hosting 5G Radio Access Network workloads on commodity hardware. This specification ensures:

* *Reliable Performance*: Consistent, predictable behavior for real-time 5G workloads
* *Tested Configurations*: Validated settings based on extensive field testing
* *Supported Standards*: Red Hat-supported configurations for production deployments
* *Optimized Resource Usage*: Efficient utilization of compute, memory, and network resources

Key RDS components include:

* *Machine Configuration*: Kernel parameters, systemd services, and OS-level tuning
* *Performance Profiles*: CPU isolation, NUMA topology awareness, and real-time scheduling
* *Network Configuration*: SR-IOV, DPDK, and high-performance networking

=== Setup a New Node and Machine Config Pool

For this and subsequent exercises, we need to deploy a new node and create a dedicated Machine Config Pool (MCP) called "workshop". 

Follow these instructions to create the new node and MCP:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Scale up +1 nodes (5min aprox)
MACHINESET=$(oc get machinesets.machine.openshift.io -n openshift-machine-api -o name | head -1)
echo "Using machineset: $MACHINESET"
oc scale $MACHINESET -n openshift-machine-api --replicas=5

# Monitoring provisioning status
oc get machines.machine.openshift.io -n openshift-machine-api

# Wait until the last provisioned node is Ready
watch oc get nodes

# Label a worker node for the new MCP (select the node with the lowest AGE - the last provisioned)
NODE=$(oc get nodes -l node-role.kubernetes.io/worker --sort-by=.metadata.creationTimestamp | tail -1 | awk '{print $1}')
echo "Selected node: $NODE"
oc label node "$NODE" node-role.kubernetes.io/workshop="" --overwrite

# Verify node labeling
oc get node -l node-role.kubernetes.io/workshop

# Create the MCP
cd /home/demo-user/troubleshooting-lab/lab-materials/01-telco-rds
oc apply -f machine_config_pool.yaml

# Verify new MCP is created and updated
watch "oc get mcp; oc get nodes"
----

[NOTE]

Expected output (takes 2-3 minutes):

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc get mcp workshop 
NAME       CONFIG                                               UPDATED   UPDATING   DEGRADED   MACHINECOUNT   READYMACHINECOUNT   UPDATEDMACHINECOUNT   DEGRADEDMACHINECOUNT   AGE
workshop   rendered-workshop-a34756497573708d31cb436f11ea8dee   True      False      False      1              1                   1                     0                      3m6s
----

The MCP is healthy when `UPDATED=True`, `UPDATING=False`, and `DEGRADED=False`. This indicates the machine configuration has been successfully applied to all nodes in the pool.



=== Cluster-Compare Plugin Purpose

The cluster-compare plugin is an OpenShift CLI tool that:

* Compares cluster configuration against reference specifications
* Reports configuration differences and compliance gaps
* Suppresses expected variations using configurable validation rules
* Provides actionable remediation guidance for non-compliant configurations

== Exercise 1: Installing the Cluster-Compare Plugin

=== Plugin Installation Process

Navigate to the lab exercise directory and install the cluster-compare plugin:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----

# Create a container for the cluster-compare image
podman create --name cca quay.io/jclaret/openshift4/kube-compare-artifacts-rhel9:latest

# Copy the cluster-compare plugin to a directory in your PATH
podman cp cca:/usr/share/openshift/linux_amd64/kube-compare.rhel9 kubectl-cluster_compare

# Make the plugin executable and move to system PATH
chmod +x kubectl-cluster_compare
sudo mv kubectl-cluster_compare /usr/local/bin/kubectl-cluster_compare

# Clean up the temporary container
podman rm cca
----

=== Verify Plugin Installation

Confirm the cluster-compare plugin is properly installed and accessible:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Verify plugin installation and view available options
oc cluster-compare -h
----

Expected output should display the plugin help information and available command options.

== Exercise 2: Extracting Reference Configuration

=== Reference Bundle Extraction

Extract the telco RAN reference configuration bundle for comparison:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Pull the ZTP site generator image containing reference configurations
podman pull quay.io/jclaret/openshift4/ztp-site-generate-rhel8:v4.18

# Create output directory for extracted reference content
mkdir -p ./out

# Extract reference bundle from the container image
podman run --log-driver=none --rm \
  quay.io/jclaret/openshift4/ztp-site-generate-rhel8:v4.18 \
  extract /home/ztp --tar | tar x -C ./out
----

This creates the out directory contains the following subdirectories:

- **out/extra-manifest** contains the source CR files that SiteConfig uses to generate extra manifest configMap.
- **out/source-crs** contains the source CR files that PolicyGenTemplate uses to generate the Red Hat Advanced Cluster Management policies.
- **out/argocd/deployment** contains patches and YAML files to apply on the hub cluster for use in the next step of this procedure.
- **out/argocd/example** contains the examples for SiteConfig and PolicyGenTemplate files that represent the recommended configuration.

=== Creating Minimal Validation Scope

For this lab exercise, we'll use a simplified metadata file focusing on essential configuration. This is a minimal, simplified configuration designed specifically for educational purposes to demonstrate how the Telco RDS (Reference Design Specification) validation process works. This configuration is not intended for production use and should not be considered a complete or production-ready setup.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Copy the simplified metadata file for lab exercise
cp metadata_workshop.yaml out/reference/metadata_workshop.yaml
cp 06-kdump-workshop.yaml out/source-crs/extra-manifest
cp 06-kdump-workshop.yaml out/extra-manifest/
cp 06-kdump-workshop.yaml out/reference/required/machine-config/kdump/

# Review the metadata content
cat out/reference/metadata_workshop.yaml
----

== Exercise 3: Detecting Configuration Drift

=== Initial Compliance Assessment

Run the cluster-compare plugin to identify configuration gaps against the RDS requirements:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Execute compliance comparison against simplified metadata
oc cluster-compare -r out/reference/metadata_workshop.yaml
----

=== Analysis Results

The cluster-compare output will likely show non-compliant configurations.

Example expected output:
[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc cluster-compare -r out/reference/metadata_workshop.yaml

Summary
CRs with diffs: 0/0
CRs in reference missing from the cluster: 1
required-machine-config:
  machine-config:
    Missing CRs:
    - required/machine-config/kdump/06-kdump-workshop.yaml
      Description:
        https://docs.openshift.com/container-platform/4.18/scalability_and_performance/telco_ref_design_specs/ran/telco-ran-ref-du-components.html#telco-ran-machine-configuration_ran-ref-design-components
No CRs are unmatched to reference CRs
Metadata Hash: dfdcc0a98940b59b6767a0c016e3a858a512df172cd37cbb11d7cf1ed9f83d40
No patched CRs
----

In this case, it shows that there's one missing MachineConfig that needs to be applied to make the cluster compliant with the telco RDS requirements.

== Exercise 4: Resolving Configuration Drift

**YOUR MISSION**: The cluster-compare output above shows a **configuration drift problem**. Your task is to:

1. **Understand the problem** - What exactly is missing and why is it critical?
2. **Find the solution** - Locate the missing configuration file in out/source-crs/extra-manifest directory and apply it
3. **Verify the fix** - Confirm the cluster is now compliant
4. **Node restart** - It is expected a node restart

**Time Limit**: 10-15 minutes of investigation before checking the solution

=== Solution Implementation

.Click to reveal the solution
[%collapsible]
====
If you've completed your investigation or need guidance, here's the solution:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Apply RDS configuration example
oc apply -f ./out/source-crs/extra-manifest/06-kdump-workshop.yaml

# Watch/Wait the MCP rollout
watch "oc get mcp workshop; oc get nodes"

# Verify compliance (run after rollout completes)
oc cluster-compare -r out/reference/metadata_workshop.yaml
----

**Understanding the problem:**

- kdump is a kernel crash dumping mechanism
- Required for telco RAN to capture crash dumps for root cause analysis  
- Missing configuration means crash dumps won't be captured during kernel panics
====

=== Verification

Wait for all Machine Config Pools to show `UPDATED=True` and `UPDATING=False`, then verify complete compliance.

Expected successful output:
[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
oc cluster-compare -r out/reference/metadata_workshop.yaml

Summary
CRs with diffs: 0/1
No validation issues with the cluster
No CRs are unmatched to reference CRs
Metadata Hash: 0f579e9dcdc519dcebfa740ba0fc0fa0dca6769890c7cfde34077c067d6e7794
No patched CRs
----

== Lab Summary

This lab demonstrated the critical importance of maintaining telco RAN RDS compliance for 5G workload reliability. Key achievements include:

* Understanding telco-specific OpenShift configuration requirements
* Installing and using the cluster-compare plugin for automated compliance validation
* Detecting and remediating configuration drift using Machine Config resources
* Verifying successful compliance remediation through automated testing

== Additional Resources

* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/edge_computing/ztp-preparing-the-hub-cluster#ztp-telco-ran-software-versions_ztp-preparing-the-hub-cluster[Telco RAN DU 4.19 validated software components]
* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/edge_computing/ztp-preparing-the-hub-cluster#ztp-preparing-the-ztp-git-repository_ztp-preparing-the-hub-cluster[Preparing the GitOps ZTP site configuration repository]