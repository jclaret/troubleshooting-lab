= RHCOS Image Layering - Applying Hotfixes
include::../_attributes.adoc[]

:imagesdir: assets/images

== Lab Overview

This lab introduces Red Hat Enterprise Linux CoreOS (RHCOS) Image Layering (now called "Image Mode" in OpenShift 4.19+) for applying hotfixes or testing kernels. You'll learn to identify package-related issues, understand when image layering is appropriate, and apply hotfixes using pre-built layered images.

=== Learning Objectives

By completing this lab, you will be able to:

* Understand RHCOS Image Layering/Image Mode concepts and use cases
* Deploy layered images using MachineConfig resources

=== Reference Documentation

* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/machine_configuration/mco-coreos-layering[RHCOS Image Layering Documentation]
* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html-single/machine_configuration/index#mco-coreos-layering[Image Mode for OpenShift (4.19+)]
* link:https://github.com/openshift/rhcos-image-layering-examples[RHCOS Image Layering Examples]

When troubleshooting RHCOS Image Layering issues, use these commands to investigate and resolve problems:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Check MachineConfig status and image references
oc get mc -o wide

# Monitor MachineConfigPool rollout
oc get mcp -o wide
oc get mcp workshop -w

# Check node status and image information
oc get nodes -o custom-columns="NAME:.metadata.name,STATUS:.status.conditions[?(@.type=='Ready')].status,VERSION:.status.nodeInfo.osImage"

# Troubleshoot MachineConfig issues
oc describe mc 99-network-tools-worker
oc get mc 99-network-tools-worker -o yaml

# Check MachineConfigPool conditions and status
oc get mcp workshop -o jsonpath='{.status.conditions}' | jq '.[] | select(.type=="Updated" or .type=="Updating" or .type=="Degraded")'

# Monitor node rollout progress
oc get nodes -l node-role.kubernetes.io/workshop -o custom-columns="NAME:.metadata.name,READY:.status.conditions[?(@.type=='Ready')].status,SCHEDULABLE:.spec.unschedulable"

# Check for MachineConfig-related events
oc get events --sort-by='.lastTimestamp' | grep -i "machineconfig\|mcp"

# Check Machine Config Operator logs
oc logs -n openshift-machine-config-operator deployment/machine-config-operator --tail=50

# Check Machine Config Daemon logs for specific node
NODE=$(oc get nodes -l node-role.kubernetes.io/workshop -o jsonpath='{.items[0].metadata.name}')
MCD_POD=$(oc get pods -n openshift-machine-config-operator -o name | grep $NODE)
oc logs -n openshift-machine-config-operator $MCD_POD --tail=50

# Check for MachineConfig-related events in MCO namespace
oc get events -n openshift-machine-config-operator --sort-by='.lastTimestamp' | grep -i "machineconfig\|mcp"

# Verify image layering on specific node
oc debug node/$NODE -- chroot /host rpm-ostree status
oc debug node/$NODE -- chroot /host rpm-ostree status --json | jq '.deployments[0].packages[] | select(.name | contains("network-tools"))'

# Get nodes from specific MCP
oc get nodes -l node-role.kubernetes.io/workshop -o name

# Check rpm-ostree status on nodes
NODE=$(oc get nodes -l node-role.kubernetes.io/workshop -o jsonpath='{.items[0].metadata.name}')
oc debug node/$NODE -- chroot /host rpm-ostree status --verbose

# Check Machine rollout events
oc get events --sort-by=.lastTimestamp | grep -E "Machine|Config"

# Monitor node reboot process
watch 'oc get nodes -l node-role.kubernetes.io/workshop; echo; oc get mcp workshop'
----

== Building Layered Images

Understanding how layered images are constructed helps troubleshoot deployment issues:

=== Installing Custom RPMs on RHCOS Nodes

RHCOS uses `rpm-ostree` for package management, which allows installing custom RPMs as overlays on the immutable base image. This is useful for applying hotfixes or custom packages without rebuilding the entire OS image.

**Example: Installing a custom RPM package**

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# 1. Download and prepare custom RPM package
mkdir custom-rpm
cd custom-rpm

# Example: Custom network tool package
# Download your custom RPM (replace with actual package)
wget https://example.com/custom-network-tool-1.0.0.el9.x86_64.rpm

# 2. Copy RPM to the target node
HOST=<node-ip>
scp custom-network-tool-1.0.0.el9.x86_64.rpm core@${HOST}:

# 3. SSH to the node and switch to root
ssh core@${HOST}
sudo -i

# 4. Check current package status
rpm -qa | grep network-tool

# 5. Install the custom RPM using rpm-ostree
cd /home/core/
rpm-ostree override replace --cache-only custom-network-tool-1.0.0.el9.x86_64.rpm

# 6. Verify the installation
rpm-ostree status
rpm -qa | grep custom-network-tool

# 7. Reboot to apply changes
systemctl reboot
----

**Key points:**
- `rpm-ostree override replace` installs the RPM as an overlay
- Changes persist across reboots but are not part of the base image
- Use `rpm-ostree override reset <package-name>` to remove custom packages
- Always reboot after installing custom RPMs to ensure proper integration

**Rollback: Removing custom RPM packages**

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# 1. SSH to the node and switch to root
HOST=<node-ip>
ssh core@${HOST}
sudo -i

# 2. Check current overrides
rpm-ostree status

# 3. Remove the custom RPM override
rpm-ostree override reset custom-network-tool

# 4. Verify the rollback
rpm-ostree status
rpm -qa | grep custom-network-tool

# 5. Reboot to apply the rollback
systemctl reboot

# 6. Verify after reboot
ssh core@${HOST}
sudo -i
rpm-ostree status
rpm -qa | grep custom-network-tool
----

**Rollback key points:**
- `rpm-ostree override reset <package-name>` removes the custom package
- The system reverts to the original package version from the base image
- Always reboot after rollback to ensure proper system state
- Use `rpm-ostree override reset --all` to remove all custom overrides

=== Image Layering Process

RHCOS Image Layering uses `rpm-ostree` and container technologies to create custom images:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Key components of the layering process:

# 1. Base RHCOS image
echo "Base image: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:..."

# 2. Containerfile structure for layering
echo "=== Containerfile Structure ==="
echo "FROM quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:..."
echo "RUN rpm-ostree cliwrap install-to-root /"
echo "RUN rpm-ostree override replace --cache-only /path/to/package.rpm"
echo "RUN rpm-ostree cleanup -m"
echo "RUN ostree container commit"

# 3. Image URL format
echo "=== Image URL Format ==="
echo "registry.domain/namespace/package-version:ocp-version"
echo "Example: quay.io/jclaret/lab/ethtool-6.2-1.el9.x86_64:4.16.30"

# 4. View source files used in this lab
ls -la source/
cat source/Containerfile_fix
----

=== Key Layering Commands

The layering process uses specific `rpm-ostree` commands:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Essential rpm-ostree commands for layering:

# Install rpm-ostree CLI wrapper
rpm-ostree cliwrap install-to-root /

# Override/replace packages
rpm-ostree override replace --cache-only /path/to/package.rpm

# Clean up metadata
rpm-ostree cleanup -m

# Commit the layered image
ostree container commit

# Check layered image status
rpm-ostree status --verbose
----

== Understanding RHCOS Image Layering

=== Diagnostic Steps: Image Layering Concepts

RHCOS Image Layering (Image Mode) allows you to create custom RHCOS images with additional packages or package updates without modifying the base CoreOS image. This is particularly useful for:

* **Security Hotfixes**: Applying critical security updates before official RHCOS releases
* **Driver Updates**: Installing updated network or storage drivers for hardware compatibility
* **Custom Tools**: Adding diagnostic or monitoring tools required for specific environments
* **Bug Fixes**: Resolving specific package bugs that affect cluster functionality

=== Key Components

* **Base RHCOS Image**: The standard CoreOS image for your OpenShift version
* **Layered Image**: Custom image with additional/updated packages
* **rpm-ostree**: Underlying technology for package layering
* **MachineConfig**: Resource that references the layered image
* **Image Registry**: Storage location for custom layered images

[IMPORTANT]
====
**Terminology Change in OpenShift 4.19+**:

- "RHCOS Image Layering" → "Image Mode for OpenShift" 
- "On-cluster layering" → "On-cluster image mode"
- "Out-of-cluster layering" → "Out-of-cluster image mode"
====


== Exercise 1: Network Tool Package Deployment

=== Scenario Setup: Network Interface Management

You need to deploy a MachineConfig that includes a network management tool package. After deployment, you'll need to verify the tool functionality on the affected nodes.

Navigate to the image layering lab directory:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Change to the RHCOS image layering lab directory
cd /home/demo-user/troubleshooting-lab/lab-materials/05-os-layering
----

=== Deploying the Configuration

Deploy the exercise scenario:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Deploy the exercise scenario
oc apply -k .

# Monitor the MachineConfigPool rollout
oc get mcp workshop -w
----

=== Testing the Network Tool

After the rollout completes, test the network tool functionality:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Get a node from the workshop MCP
NODE=$(oc get nodes -l node-role.kubernetes.io/workshop -o jsonpath='{.items[0].metadata.name}')
echo "Testing on node: $NODE"

# Try to get network interface information
INTERFACE=$(oc debug node/$NODE -- chroot /host ip route | grep default | awk '{print $5}' | head -1)
echo "Testing interface: $INTERFACE"
oc debug node/$NODE -- chroot /host ethtool -i $INTERFACE
----

=== Investigation Challenge

**YOUR MISSION**: Test the network tool functionality and verify it's working correctly.

**What to check:**

- Does the ethtool command work as expected?
- Can you retrieve network interface information?
- Are there any errors or unexpected behavior?

Use the troubleshooting commands from the "RHCOS Image Layering Troubleshooting Commands" section above if you encounter issues.

== Exercise 2: Creating and Applying the Fix

=== Understanding the Problem

If you discovered that the network tool is not working as expected, this is likely due to a package issue. The ethtool package version 99.0-1.el9 contains a critical bug that prevents proper network interface management. This is a common scenario where a package update introduces regressions.

=== Creating the Fix

You need to create a MachineConfig that uses a corrected version of the ethtool package. A pre-built layered image with the fix is available.

**Your task:** Complete the MachineConfig template provided in the lab directory.

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Review the MachineConfig template
cat machine-config-template.yaml

# Complete the template with the correct image URL
# The fixed image is: quay.io/jclaret/lab/ethtool-6.2-1.el9.x86_64:4.16.30
# Replace "REPLACE_WITH_CORRECT_IMAGE_URL" with the actual image URL

# Edit the template file
vi machine-config-template.yaml

# Apply your completed MachineConfig
oc apply -f machine-config-template.yaml
----

=== Solution Implementation

.Click to reveal the solution
[%collapsible]
====
**Understanding the problem:**

- The ethtool package version 99.0-1.el9 contains a critical bug
- This prevents proper network interface management
- RHCOS Image Layering can be used to deploy a hotfix with the corrected package version

**Solution Implementation:**
Apply the hotfix using the corrected MachineConfig:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Apply the hotfix MachineConfig with the corrected ethtool version
oc apply -k solution/

# Monitor the MachineConfigPool rollout for the fix
oc get mcp workshop -w
----
====

=== Verification

Verify that the hotfix was applied successfully:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Get the node that received the hotfix
NODE=$(oc get nodes -l node-role.kubernetes.io/workshop -o jsonpath='{.items[0].metadata.name}')
echo "Verifying node: $NODE"

# Verify the corrected ethtool version is installed
oc debug node/$NODE -- chroot /host rpm -q ethtool

# Expected output: ethtool-6.2-1.el9.x86_64

# Test ethtool functionality with the fixed version
oc debug node/$NODE -- chroot /host ethtool --version

# Verify network interface operations work correctly
INTERFACE=$(oc debug node/$NODE -- chroot /host ip route | grep default | awk '{print $5}' | head -1)
echo "Testing interface: $INTERFACE"
oc debug node/$NODE -- chroot /host ethtool -i $INTERFACE

# Check that network statistics are now accessible
oc debug node/$NODE -- chroot /host ethtool -S $INTERFACE | head -10

# Verify the layered image is properly applied
oc debug node/$NODE -- chroot /host rpm-ostree status
----

== Lab Summary

This lab demonstrated the practical application of RHCOS Image Layering for hotfix deployment:

* **Package Issue Identification**: Recognized network driver problems caused by buggy ethtool version
* **Image Layering Understanding**: Learned when and how to use layered images for hotfixes
* **Hotfix Deployment**: Successfully applied a corrected package using MachineConfig with layered image
* **Verification Process**: Confirmed both package version and functionality after hotfix application
* **Architecture Analysis**: Understood the underlying rpm-ostree and container technologies

== Additional Resources

* link:https://github.com/openshift/rhcos-image-layering-examples/blob/master/override-kernel/Containerfile[Kernel Override Example]
* link:https://issues.redhat.com/browse/OCPBUGS-30149[OpenShift Image Layering Enhancements]
* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/release_notes/ocp-4-19-release-notes[OpenShift 4.19 Image Mode Updates]
