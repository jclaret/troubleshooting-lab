= OpenShift Security - SCC Troubleshooting
include::../_attributes.adoc[]

== Lab Overview

This lab focuses on troubleshooting Security Context Constraints (SCC) issues when applications require elevated privileges to perform kernel-level operations. You'll learn to identify permission-related failures, understand SCC requirements for specific capabilities, and configure appropriate security contexts for applications that need to load kernel modules.

=== Learning Objectives

By completing this lab, you will be able to:

* Understand Security Context Constraints (SCC) and their role in OpenShift security
* Diagnose application failures related to insufficient privileges
* Identify when applications require specific Linux capabilities
* Create custom SCCs for applications with special requirements
* Configure ServiceAccounts and bind them to appropriate SCCs
* Troubleshoot common privilege escalation issues in containerized environments

=== Reference Documentation

* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/authentication_and_authorization/managing-security-context-constraints[Managing Security Context Constraints]
* link:https://kubernetes.io/docs/concepts/security/pod-security-standards/[Kubernetes Pod Security Standards]
* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/authentication_and_authorization/understanding-and-creating-service-accounts[Understanding Service Accounts]

== Understanding Security Context Constraints

=== Diagnostic Steps: SCC Architecture and Purpose

Security Context Constraints (SCCs) define a set of conditions that pods must run with to be accepted into the system. They control:

* **User and Group IDs**: What user/group the container runs as
* **Linux Capabilities**: Specific kernel capabilities like SYS_MODULE, NET_ADMIN
* **SELinux Context**: Security Enhanced Linux context types
* **File System Access**: Volume types and file system group policies
* **Privileged Containers**: Whether containers can run in privileged mode

=== Information Gathering: Default SCCs in OpenShift

OpenShift provides several built-in SCCs with different security levels:

[source,bash]
----
# View all available SCCs
oc get scc

# Examine specific SCC details
oc describe scc restricted-v2
oc describe scc privileged

# Check which SCC is applied to running pods
oc get pods -o custom-columns="NAME:.metadata.name,SCC:.metadata.annotations.openshift\.io/scc"
----

**Common OpenShift SCCs**:
- `restricted-v2`: Default restrictive SCC (most secure)
- `restricted`: Legacy default SCC
- `nonroot-v2`: Allows non-root users with additional capabilities
- `privileged`: Full access (least secure)
- `hostmount-anyuid`: Host volume access with any UID

=== Key SCC Components

* **allowPrivilegedContainer**: Permits privileged container execution
* **allowedCapabilities**: Linux capabilities that can be added to containers
* **runAsUser**: User ID constraints for container execution
* **seLinuxContext**: SELinux context requirements
* **users/groups**: ServiceAccounts or users authorized to use the SCC

== Exercise 1: Deploying Application with Insufficient Privileges

=== Problem Definition: Kernel Module Loading Failure

Navigate to the SCC troubleshooting lab and deploy the initial problematic configuration:

[source,bash]
----
# Change to the SCC troubleshooting lab directory
cd troubleshooting-lab/lab-materials/03-sec-scc/lab1-module

# Create a new namespace for better isolation
oc new-project module-app

# Deploy the application that requires kernel module loading
oc apply -f module-app.yaml

# Verify deployment status
oc get pods -n module-app
oc describe deployment kernel-mod-app -n module-app
----

=== Information Gathering: Initial Problem Analysis

Monitor the application and investigate any issues:

[source,bash]
----
# Check pod status and events
oc get pods -n module-app
oc describe pod -l app=kernel-mod-app -n module-app

# Examine pod logs for error messages
oc logs -l app=kernel-mod-app -n module-app

# Check which SCC is currently applied
oc get pod -l app=kernel-mod-app -n module-app -o jsonpath='{.items[0].metadata.annotations.openshift\.io/scc}'

# Verify current security context
oc get pod -l app=kernel-mod-app -n module-app -o jsonpath='{.items[0].spec.securityContext}'

# Verify the kernel module exists in the container
oc exec -n module-app deployment/kernel-mod-app -- ls -la /app/hello.ko

# Try to manually load the module (should fail)
oc exec -n module-app deployment/kernel-mod-app -- insmod /app/hello.ko
----

=== Hypothesis Development: Understanding the Failure

The application will likely fail to load the kernel module due to insufficient privileges. Investigate the specific error:

== Exercise 2: Investigating SCC Requirements

=== Investigation Challenge

Before looking at the solution, spend 15-20 minutes investigating:

1. **What Linux capability is required to load kernel modules?**
2. **Which SCC is currently applied to the pod and why?**
3. **What SCC features are needed for kernel module operations?**
4. **How do you create a custom SCC for specific application requirements?**

[TIP]
====
ðŸ’¡ **Hint**: The application needs the `SYS_MODULE` capability to load kernel modules. Check the current SCC applied to the pod and compare it with the `privileged` SCC to understand what's missing.

Key investigation commands:
- `oc describe scc restricted-v2`
- `oc get pod -l app=kernel-mod-app -n module-app -o yaml | grep -A 5 -B 5 scc`
- `oc logs -l app=kernel-mod-app -n module-app | grep -i module`
- Research Linux capabilities: `man 7 capabilities`
====

== Exercise 3: Creating Custom SCC and ServiceAccount

=== Solution Implementation: Configuring Appropriate Security Context

Apply the solution step by step:

[source,bash]
----
# Step 1: Create a custom SCC with SYS_MODULE capability
oc apply -f solution/scc.yaml

# Step 2: Create a ServiceAccount for the application
oc create serviceaccount module-loader -n module-app

# Step 3: Bind the ServiceAccount to the custom SCC
oc adm policy add-scc-to-user scc-sysmodule -z module-loader -n module-app

# Step 4: Verify the SCC binding
oc adm policy who-can use scc scc-sysmodule

# Step 5: Update the deployment to use the ServiceAccount
oc apply -f solution/deployment.yaml -n module-app
----

=== Testing and Validation: Monitoring the Fix

Monitor the deployment rollout and verify the fix:

[source,bash]
----
# Watch the deployment rollout
oc rollout status deployment/kernel-mod-app -n module-app

# Check the new pod's SCC
oc get pod -l app=kernel-mod-app -n module-app -o jsonpath='{.items[0].metadata.annotations.openshift\.io/scc}'

# Verify the security context is correctly applied
oc describe pod -l app=kernel-mod-app -n module-app | grep -A 10 "Security Context"

# Check application logs for successful module loading
oc logs -l app=kernel-mod-app -n module-app --tail=20
----

=== Verification and Documentation: Confirming Success

Verify that the kernel module is now loaded successfully:

[source,bash]
----
# Check if the module loaded successfully
oc logs -l app=kernel-mod-app -n module-app | grep -i "hello"

# Verify the module is loaded in the kernel
oc exec -n module-app deployment/kernel-mod-app -- lsmod | grep hello

# Check kernel messages
oc exec -n module-app deployment/kernel-mod-app -- dmesg | tail -10

# Verify the SYS_MODULE capability is present
oc exec -n module-app deployment/kernel-mod-app -- cat /proc/self/status | grep CapEff

# Test manual module operations
oc exec -n module-app deployment/kernel-mod-app -- rmmod hello
oc exec -n module-app deployment/kernel-mod-app -- insmod /app/hello.ko
oc exec -n module-app deployment/kernel-mod-app -- lsmod | grep hello
----

== Lab Summary

This lab demonstrated essential SCC troubleshooting skills for applications requiring elevated privileges:

* **Problem Identification**: Recognized kernel module loading failures due to insufficient capabilities
* **SCC Analysis**: Understood the relationship between SCCs, capabilities, and security contexts
* **Custom SCC Creation**: Created a targeted SCC with specific capabilities instead of using privileged access
* **ServiceAccount Management**: Properly bound ServiceAccounts to custom SCCs
* **Security Evaluation**: Analyzed security implications and alternative approaches

== Additional Resources

* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/authentication_and_authorization/managing-security-context-constraints#security-context-constraints-command-reference_configuring-internal-oauth[SCC Command Reference]
* link:https://kubernetes.io/docs/tasks/configure-pod-container/security-context/[Configure Security Context for Pod]
* link:https://man7.org/linux/man-pages/man7/capabilities.7.html[Linux Capabilities Manual]
* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/authentication_and_authorization/understanding-and-creating-service-accounts[ServiceAccount Documentation]
