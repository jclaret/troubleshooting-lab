= OpenShift Security - SCC Troubleshooting
include::../_attributes.adoc[]

:imagesdir: assets/images

== Lab Overview

This lab focuses on troubleshooting Security Context Constraints (SCC) issues when applications require elevated privileges to perform kernel-level operations. You'll learn to identify permission-related failures, understand SCC requirements for specific capabilities, and configure appropriate security contexts for applications that need to load kernel modules.

=== Learning Objectives

By completing this lab, you will be able to:

* Understand Security Context Constraints (SCC) and their role in OpenShift security
* Diagnose application failures related to insufficient privileges
* Identify when applications require specific Linux capabilities
* Create custom SCCs for applications with special requirements
* Configure ServiceAccounts and bind them to appropriate SCCs
* Troubleshoot common privilege escalation issues in containerized environments

=== Reference Documentation

* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/authentication_and_authorization/managing-security-context-constraints[Managing Security Context Constraints]
* link:https://kubernetes.io/docs/concepts/security/pod-security-standards/[Kubernetes Pod Security Standards]
* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/authentication_and_authorization/understanding-and-creating-service-accounts[Understanding Service Accounts]

== SCC Troubleshooting Commands

When troubleshooting Security Context Constraints (SCC) issues, use these commands to investigate and resolve problems:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Check all available SCCs
oc get scc

# Examine specific SCC details
oc describe scc restricted-v2
oc describe scc privileged

# Check which SCC is applied to running pods
oc get pods -o custom-columns="NAME:.metadata.name,SCC:.metadata.annotations.openshift\.io/scc"

# Get pod security context details
oc get pod -l app=kernel-mod-app -o jsonpath='{.items[0].spec.securityContext}'

# Check ServiceAccount SCC bindings
oc adm policy who-can use scc scc-sysmodule

# View pod events for security-related issues
oc get events --sort-by='.lastTimestamp' | grep -i "security\|scc\|capability"

# Check pod logs for capability-related errors
oc logs -l app=kernel-mod-app --tail=50 | grep -i "permission\|capability\|module"

# Verify Linux capabilities in running container
oc exec -n module-app deployment/kernel-mod-app -- cat /proc/self/status | grep CapEff

# Test kernel module operations
oc exec -n module-app deployment/kernel-mod-app -- lsmod
oc exec -n module-app deployment/kernel-mod-app -- insmod /app/hello.ko
oc exec -n module-app deployment/kernel-mod-app -- rmmod hello

# Check SELinux context
oc exec -n module-app deployment/kernel-mod-app -- id -Z

# Verify ServiceAccount details
oc get serviceaccount module-loader -o yaml
oc describe serviceaccount module-loader
----

== Understanding Security Context Constraints

=== Diagnostic Steps: SCC Architecture and Purpose

Security Context Constraints (SCCs) define a set of conditions that pods must run with to be accepted into the system. They control:

* **User and Group IDs**: What user/group the container runs as
* **Linux Capabilities**: Specific kernel capabilities like SYS_MODULE, NET_ADMIN
* **SELinux Context**: Security Enhanced Linux context types
* **File System Access**: Volume types and file system group policies
* **Privileged Containers**: Whether containers can run in privileged mode

=== Information Gathering: Default SCCs in OpenShift

OpenShift provides several built-in SCCs with different security levels:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# View all available SCCs
oc get scc

# Examine specific SCC details
oc describe scc restricted-v2
oc describe scc privileged

# Check which SCC is applied to running pods
oc get pods -o custom-columns="NAME:.metadata.name,SCC:.metadata.annotations.openshift\.io/scc"
----

**Common OpenShift SCCs**:
- `restricted-v2`: Default restrictive SCC (most secure)
- `restricted`: Legacy default SCC
- `nonroot-v2`: Allows non-root users with additional capabilities
- `privileged`: Full access (least secure)
- `hostmount-anyuid`: Host volume access with any UID

=== Key SCC Components

* **allowPrivilegedContainer**: Permits privileged container execution
* **allowedCapabilities**: Linux capabilities that can be added to containers
* **runAsUser**: User ID constraints for container execution
* **seLinuxContext**: SELinux context requirements
* **users/groups**: ServiceAccounts or users authorized to use the SCC

== Exercise 1: Troubleshooting Kernel Module Application

=== Scenario Setup: Application Requiring Kernel Operations

Navigate to the SCC troubleshooting lab and deploy the exercise scenario:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Change to the SCC troubleshooting lab directory
cd troubleshooting-lab/lab-materials/03-sec-scc/lab1-module

# Create a new namespace for better isolation
oc new-project module-app

# Deploy the exercise scenario
oc apply -k .

# Monitor deployment status
oc get pods -n module-app -w
----

=== Investigation Challenge

**YOUR MISSION**: Investigate the application behavior and identify any issues.

**What to check:**

- Does the application start successfully?
- Are there any error messages in the logs?
- What SCC is currently applied to the pod?
- Can the application perform its intended operations?
- Are there any permission-related failures?

Use the troubleshooting commands provided earlier to investigate the application behavior.

== Exercise 2: Resolving Security Context Issues

=== Understanding the Problem

If you discovered that the application is failing to load kernel modules, this indicates a Security Context Constraint (SCC) issue. The application requires specific Linux capabilities that are not available in the default SCC.

=== Creating the Solution

**YOUR MISSION**: Create the necessary security configuration to allow the application to function properly.

**Steps to complete:**

1. **Create a custom SCC** with the required capabilities
2. **Create a ServiceAccount** for the application
3. **Bind the ServiceAccount** to the custom SCC
4. **Update the deployment** to use the new ServiceAccount

The solution will create all necessary resources automatically.

.Click to reveal the solution
[%collapsible]
====
**Solution Implementation:**

Apply the solution step by step:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Apply the complete solution
oc apply -k solution/

# Verify the SCC binding
oc adm policy who-can use scc scc-sysmodule
----
====

=== Verification

Monitor the deployment rollout and verify the fix:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Watch the deployment rollout
oc rollout status deployment/kernel-mod-app -n module-app

# Check the new pod's SCC
oc get pod -l app=kernel-mod-app -n module-app -o jsonpath='{.items[0].metadata.annotations.openshift\.io/scc}'

# Verify the security context is correctly applied
oc describe pod -l app=kernel-mod-app -n module-app | grep -A 10 "Security Context"

# Check application logs for successful module loading
oc logs -l app=kernel-mod-app -n module-app --tail=20

# Verify the module is loaded in the kernel
oc exec -n module-app deployment/kernel-mod-app -- lsmod | grep hello

# Verify the SYS_MODULE capability is present
oc exec -n module-app deployment/kernel-mod-app -- cat /proc/self/status | grep CapEff

# Test manual module operations
oc exec -n module-app deployment/kernel-mod-app -- rmmod hello
oc exec -n module-app deployment/kernel-mod-app -- insmod /app/hello.ko
oc exec -n module-app deployment/kernel-mod-app -- lsmod | grep hello
----

== Lab Summary

This lab demonstrated essential SCC troubleshooting skills for applications requiring elevated privileges:

* **Problem Identification**: Recognized kernel module loading failures due to insufficient capabilities
* **SCC Analysis**: Understood the relationship between SCCs, capabilities, and security contexts
* **Custom SCC Creation**: Created a targeted SCC with specific capabilities instead of using privileged access
* **ServiceAccount Management**: Properly bound ServiceAccounts to custom SCCs
* **Security Evaluation**: Analyzed security implications and alternative approaches

== Additional Resources

* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/authentication_and_authorization/managing-security-context-constraints#security-context-constraints-command-reference_configuring-internal-oauth[SCC Command Reference]
* link:https://kubernetes.io/docs/tasks/configure-pod-container/security-context/[Configure Security Context for Pod]
* link:https://man7.org/linux/man-pages/man7/capabilities.7.html[Linux Capabilities Manual]
* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/authentication_and_authorization/understanding-and-creating-service-accounts[ServiceAccount Documentation]
