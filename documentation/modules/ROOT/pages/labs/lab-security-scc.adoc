= OpenShift Security - SCC Troubleshooting
include::../_attributes.adoc[]

:imagesdir: assets/images

== Lab Overview

This lab focuses on troubleshooting Security Context Constraints (SCC) issues when applications require elevated privileges to perform kernel-level operations. You'll learn to identify permission-related failures, understand SCC requirements for specific capabilities, and configure appropriate security contexts for applications that need to load kernel modules.

=== Learning Objectives

By completing this lab, you will be able to:

* Understand Security Context Constraints (SCC) and their role in OpenShift security
* Diagnose application failures related to insufficient privileges
* Identify when applications require specific Linux capabilities
* Create custom SCCs for applications with special requirements
* Configure ServiceAccounts and bind them to appropriate SCCs
* Troubleshoot common privilege escalation issues in containerized environments

=== Reference Documentation

* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/authentication_and_authorization/managing-security-context-constraints[Managing Security Context Constraints]
* link:https://kubernetes.io/docs/concepts/security/pod-security-standards/[Kubernetes Pod Security Standards]
* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/authentication_and_authorization/understanding-and-creating-service-accounts[Understanding Service Accounts]

== SCC Troubleshooting Commands

When troubleshooting Security Context Constraints (SCC) issues, use these commands to investigate and resolve problems:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Check all available SCCs
oc get scc

# Examine specific SCC details
oc describe scc restricted-v2
oc describe scc privileged

# Check which SCC is applied to running pods
oc get pods -o custom-columns="NAME:.metadata.name,SCC:.metadata.annotations.openshift\.io/scc"

# Get pod security context details
oc get pod -l app=kernel-mod-app -o jsonpath='{.items[0].spec.securityContext}'

# Check ServiceAccount SCC bindings
oc adm policy who-can use scc scc-sysmodule

# View pod events for security-related issues
oc get events --sort-by='.lastTimestamp' | grep -i "security\|scc\|capability"

# Check pod logs for capability-related errors
oc logs -l app=kernel-mod-app --tail=50 | grep -i "permission\|capability\|module"

# Verify Linux capabilities in running container
oc exec -n module-app deployment/kernel-mod-app -- cat /proc/self/status | grep CapEff

# Test kernel module operations
oc exec -n module-app deployment/kernel-mod-app -- lsmod
oc exec -n module-app deployment/kernel-mod-app -- insmod /app/hello.ko
oc exec -n module-app deployment/kernel-mod-app -- rmmod hello

# Check SELinux context
oc exec -n module-app deployment/kernel-mod-app -- id -Z

# Verify ServiceAccount details
oc get serviceaccount module-loader -o yaml
oc describe serviceaccount module-loader
----

== Understanding Security Context Constraints

=== Diagnostic Steps: SCC Architecture and Purpose

Security Context Constraints (SCCs) define a set of conditions that pods must run with to be accepted into the system. They control:

* **User and Group IDs**: What user/group the container runs as
* **Linux Capabilities**: Specific kernel capabilities like SYS_MODULE, NET_ADMIN
* **SELinux Context**: Security Enhanced Linux context types
* **File System Access**: Volume types and file system group policies
* **Privileged Containers**: Whether containers can run in privileged mode

=== Information Gathering: Default SCCs in OpenShift

OpenShift provides several built-in SCCs with different security levels:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# View all available SCCs
oc get scc

# Examine specific SCC details
oc describe scc restricted-v2
oc describe scc privileged

# Check which SCC is applied to running pods
oc get pods -o custom-columns="NAME:.metadata.name,SCC:.metadata.annotations.openshift\.io/scc"
----

**Common OpenShift SCCs**:

- `restricted-v2`: Default restrictive SCC (most secure)
- `restricted`: Legacy default SCC
- `nonroot-v2`: Allows non-root users with additional capabilities
- `privileged`: Full access (least secure)
- `hostmount-anyuid`: Host volume access with any UID

=== Key SCC Components

* **allowPrivilegedContainer**: Permits privileged container execution
* **allowedCapabilities**: Linux capabilities that can be added to containers
* **runAsUser**: User ID constraints for container execution
* **seLinuxContext**: SELinux context requirements
* **users/groups**: ServiceAccounts or users authorized to use the SCC

== Exercise 1: Troubleshooting Kernel Module Application

=== Understanding the Application

This exercise involves a containerized application that attempts to load a kernel module called "hello". The application requires specific Linux capabilities to perform this operation, which are restricted by default Security Context Constraints (SCCs) in OpenShift.

=== Scenario Setup

Navigate to the SCC troubleshooting lab and deploy the exercise scenario:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Change to the SCC troubleshooting lab directory
cd /home/demo-user/troubleshooting-lab/lab-materials/03-sec-scc/lab1-module

# Deploy the exercise scenario
oc apply -k .

# Monitor deployment status
oc get pods -n module-app -w
----

=== Investigation Challenge

**YOUR MISSION**: Investigate why the application is failing to load the kernel module and resolve the security context issues.

**What to check:**

- **Pod Status**: Is the pod running or failing?
- **Application Logs**: What error messages appear when trying to load the kernel module?
- **SCC Applied**: What Security Context Constraint is currently applied to the pod?
- **Security Context**: What security context is configured for the container?
- **Permission Errors**: Are there any capability-related failures?

**Step-by-Step Investigation:**

1. **Check pod status and events:**
[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Check pod status
oc get pods -n module-app

# Check pod events for any errors
oc describe pod -l app=kernel-mod-app -n module-app
----

2. **Examine application logs:**
[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Check application logs for kernel module loading errors
oc logs -l app=kernel-mod-app -n module-app
----

3. **Analyze security context:**
[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Check what SCC is applied to the pod
oc get pod -l app=kernel-mod-app -n module-app -o jsonpath='{.items[0].metadata.annotations.openshift\.io/scc}'

# Check the security context configuration
oc describe pod -l app=kernel-mod-app -n module-app | grep -A 10 "Security Context"
----

.Click to reveal the solution
[%collapsible]
====
**Understanding the problem:**

The application is failing because it requires the `SYS_MODULE` capability to load kernel modules, but the default SCC (`restricted`) doesn't allow this capability. The pod will either fail to start or the application will fail when trying to load the kernel module.

**Solution Implementation:**

Apply the solution that creates the necessary security configuration:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Apply the complete solution
oc apply -k solution/

# Verify the SCC binding
oc adm policy who-can use scc scc-sysmodule
----

**Verification and Analysis:**

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Watch the deployment rollout
oc rollout status deployment/kernel-mod-app -n module-app

# Check the new pod's SCC
oc get pod -l app=kernel-mod-app -n module-app -o jsonpath='{.items[0].metadata.annotations.openshift\.io/scc}'

# Check application logs for successful module loading
oc logs -l app=kernel-mod-app -n module-app --tail=20

# Verify the module is loaded in the kernel
oc exec -n module-app deployment/kernel-mod-app -- lsmod | grep hello

# Verify the SYS_MODULE capability is present
oc exec -n module-app deployment/kernel-mod-app -- cat /proc/self/status | grep CapEff
----

**Understanding the Solution Components:**

Now let's examine the security components that were created:

1. **Examine the custom SCC:**
[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# View the custom SCC configuration
oc get scc scc-sysmodule -o yaml

# Check what capabilities are allowed
oc describe scc scc-sysmodule
----

2. **Review the ServiceAccount:**
[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Check the ServiceAccount
oc get serviceaccount module-loader -n module-app -o yaml

# Verify SCC binding
oc adm policy who-can use scc scc-sysmodule
----

3. **Analyze the security context:**
[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Check the deployment's security context
oc get deployment kernel-mod-app -n module-app -o yaml | grep -A 20 "securityContext"

# Verify the pod's security context
oc describe pod -l app=kernel-mod-app -n module-app | grep -A 15 "Security Context"
----

4. **Test manual module operations:**
[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Test manual module operations
oc exec -n module-app deployment/kernel-mod-app -- rmmod hello
oc exec -n module-app deployment/kernel-mod-app -- insmod /app/hello.ko
oc exec -n module-app deployment/kernel-mod-app -- lsmod | grep hello
----
====

== Lab Summary

This lab demonstrated essential SCC troubleshooting skills for applications requiring elevated privileges:

* **Problem Identification**: Recognized kernel module loading failures due to insufficient capabilities
* **SCC Analysis**: Understood the relationship between SCCs, capabilities, and security contexts
* **Custom SCC Creation**: Created a targeted SCC with specific capabilities instead of using privileged access
* **ServiceAccount Management**: Properly bound ServiceAccounts to custom SCCs
* **Security Evaluation**: Analyzed security implications and alternative approaches

== Additional Resources

* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/authentication_and_authorization/managing-security-context-constraints#security-context-constraints-command-reference_configuring-internal-oauth[SCC Command Reference]
* link:https://kubernetes.io/docs/tasks/configure-pod-container/security-context/[Configure Security Context for Pod]
* link:https://man7.org/linux/man-pages/man7/capabilities.7.html[Linux Capabilities Manual]
* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/authentication_and_authorization/understanding-and-creating-service-accounts[ServiceAccount Documentation]
