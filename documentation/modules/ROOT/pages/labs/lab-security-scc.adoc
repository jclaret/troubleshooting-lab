= OpenShift Security - SCC Troubleshooting
include::../_attributes.adoc[]

:imagesdir: assets/images

== Lab Overview

This lab focuses on troubleshooting Security Context Constraints (SCC) issues when applications require elevated privileges to perform kernel-level operations. You'll learn to identify permission-related failures, understand SCC requirements for specific capabilities, and configure appropriate security contexts for applications that need to load kernel modules.

=== Learning Objectives

By completing this lab, you will be able to:

* Understand Security Context Constraints (SCC) and their role in OpenShift security
* Diagnose application failures related to insufficient privileges
* Identify when applications require specific Linux capabilities
* Create custom SCCs for applications with special requirements
* Configure ServiceAccounts and bind them to appropriate SCCs
* Troubleshoot common privilege escalation issues in containerized environments

=== Reference Documentation

* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/authentication_and_authorization/managing-security-context-constraints[Managing Security Context Constraints]
* link:https://kubernetes.io/docs/concepts/security/pod-security-standards/[Kubernetes Pod Security Standards]
* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/authentication_and_authorization/understanding-and-creating-service-accounts[Understanding Service Accounts]

== SCC Troubleshooting Commands

When troubleshooting Security Context Constraints (SCC) issues, use these commands to investigate and resolve problems:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Check all available SCCs
oc get scc

# Examine specific SCC details
oc describe scc restricted-v2
oc describe scc privileged

# Check which SCC is applied to running pods
oc get pods -o custom-columns="NAME:.metadata.name,SCC:.metadata.annotations.openshift\.io/scc"

# Get pod security context details
oc get pod -l app=kernel-mod-app -o jsonpath='{.items[0].spec.securityContext}'

# Check ServiceAccount SCC bindings
oc adm policy who-can use scc scc-sysmodule-min

# View pod events for security-related issues
oc get events --sort-by='.lastTimestamp' | grep -i "security\|scc\|capability"

# Gather audit logs
oc adm must-gather -- /usr/bin/gather_audit_logs

# Search for SCC admission decisions
find must-gather* -ipath '*kube-apiserver*/*audit*.log.gz' | xargs zgrep -h securitycontextconstraints.admission.openshift.io | grep module-app | jq '.'
----

== Understanding Security Context Constraints

=== Diagnostic Steps: SCC Architecture and Purpose

Security Context Constraints (SCCs) define a set of conditions that pods must run with to be accepted into the system. They control:

* **User and Group IDs**: What user/group the container runs as
* **Linux Capabilities**: Specific kernel capabilities like SYS_MODULE, NET_ADMIN
* **SELinux Context**: Security Enhanced Linux context types
* **File System Access**: Volume types and file system group policies
* **Privileged Containers**: Whether containers can run in privileged mode

=== Information Gathering: Default SCCs in OpenShift

OpenShift provides several built-in SCCs with different security levels:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# View all available SCCs
oc get scc

# Examine specific SCC details
oc describe scc restricted-v2
oc describe scc privileged

# Check which SCC is applied to running pods
oc get pods -o custom-columns="NAME:.metadata.name,SCC:.metadata.annotations.openshift\.io/scc"
----

**Common OpenShift SCCs**:

- `restricted-v2`: Default restrictive SCC (most secure)
- `restricted`: Legacy default SCC
- `nonroot-v2`: Allows non-root users with additional capabilities
- `privileged`: Full access (least secure)
- `hostmount-anyuid`: Host volume access with any UID

=== Key SCC Components

* **allowPrivilegedContainer**: Permits privileged container execution
* **allowedCapabilities**: Linux capabilities that can be added to containers
* **runAsUser**: User ID constraints for container execution
* **seLinuxContext**: SELinux context requirements
* **users/groups**: ServiceAccounts or users authorized to use the SCC

== Exercise 1: Troubleshooting Application permissions

=== Understanding the Application

This exercise involves a containerized application that attempts to load a kernel module called "hello". The application requires specific Linux capabilities to perform this operation, which are restricted by default Security Context Constraints (SCCs) in OpenShift.

=== Scenario Setup

Navigate to the SCC troubleshooting lab and deploy the exercise scenario:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Change to the SCC troubleshooting lab directory
cd /home/demo-user/troubleshooting-lab/lab-materials/03-sec-scc/lab1-module

# Deploy the exercise scenario
oc apply -k .

# Monitor deployment status
oc get pods -n module-app 

# Check application logs
oc logs -n module-app -l app=kernel-mod-app

# Check SCC used by the pod
oc get pods -n module-app -o custom-columns="NAME:.metadata.name,SCC:.metadata.annotations.openshift\.io/scc"
----

=== Understanding the Required Configuration

To resolve the kernel module loading issue, the deployment needs to be configured with:

- **ServiceAccount** (serviceaccount.yaml): A dedicated ServiceAccount for the application
- **Custom SCC**(scc.yaml): A Security Context Constraint with the necessary permissions for kernel module operations
- **Security Context**: Proper security context configuration in the deployment

**Required securityContext configuration:**

[.lines_space]
[.console-input]
[source,yaml, subs="+macros,+attributes"]
----
securityContext:
  runAsUser: 0
  allowPrivilegeEscalation: false
  capabilities:
    add: ["SYS_MODULE"]
  seLinuxOptions:
    type: spc_t
----

=== Expected Error Analysis

After deploying the initial configuration, investigate why the kernel module is still not loading correctly.

**Expected error messages:**
[.lines_space]
[.console-output]
[source,text]
----
Error: rmmod: ERROR: could not remove 'hello': Operation not permitted
rmmod: ERROR: could not remove module hello: Operation not permitted
----

=== Investigation Challenge

**YOUR MISSION**: Investigate why the application is failing and understand the SCC selection process.

**What to check:**

- **Pod Status**: Is the pod running or failing?
- **Application Logs**: What error messages appear when trying to load the kernel module?
- **SCC Applied**: What Security Context Constraint is currently applied to the pod?
- **ServiceAccount**: Does the ServiceAccount exist and have proper permissions?



.Click to reveal the solution
[%collapsible]
====
**Understanding the problem:**

The application is failing because:
1. The ServiceAccount `module-loader` exists but has no SCC permissions
2. The application uses `SYS_ADMIN` capability instead of `SYS_MODULE`
3. The custom SCC `scc-sysmodule-min` exists but has no users assigned to it

**Step-by-Step Investigation:**

- **Check steps:**

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Check pod status
oc get pods -n module-app

# Check application logs for errors
oc logs -l app=kernel-mod-app -n module-app

# Check the deployment if there's no pods created
oc get deployment kernel-mod-app -o yaml

# Check what SCC is applied to the pod
oc get pods -n module-app --output=custom-columns="NAME:.metadata.name,STATUS:.metadata.annotations.openshift\.io/scc"

# Check if ServiceAccount exists
oc get serviceaccount module-loader -n module-app

# Check SCC permissions for the ServiceAccount
oc adm policy who-can use scc scc-sysmodule-min

# Gather audit logs
oc adm must-gather -- /usr/bin/gather_audit_logs

# Search for SCC admission decisions
find must-gather* -ipath '*kube-apiserver*/*audit*.log.gz' | xargs zgrep -h securitycontextconstraints.admission.openshift.io | grep module-app | jq '.'
----

**Solution Implementation:**

1. **Grant SCC permissions to the existing ServiceAccount:**
[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Grant SCC permissions to the existing ServiceAccount
oc adm policy add-scc-to-user scc-sysmodule-min -z module-loader -n module-app
----

2. **Update the deployment with correct capabilities:**
[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Apply the corrected deployment
oc apply -f solution/deployment.yaml
----

**Verification:**

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Watch the deployment rollout
oc rollout status deployment/kernel-mod-app -n module-app

# Check the new pod's SCC
oc get pod -l app=kernel-mod-app -n module-app -o jsonpath='{.items[0].metadata.annotations.openshift\.io/scc}'

# Check application logs for successful module loading
oc logs -l app=kernel-mod-app -n module-app --tail=20

# Verify the module is loaded in the kernel
oc exec -n module-app deployment/kernel-mod-app -- lsmod | grep hello

# Verify SCC permissions
oc adm policy who-can use scc scc-sysmodule-min
----

====

**Verification and Analysis:**

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Watch the deployment rollout
oc rollout status deployment/kernel-mod-app -n module-app

# Check the new pod's SCC
oc get pod -l app=kernel-mod-app -n module-app -o jsonpath='{.items[0].metadata.annotations.openshift\.io/scc}'

# Check application logs for successful module loading
oc logs -l app=kernel-mod-app -n module-app --tail=20

# Verify the module is loaded in the kernel
oc exec -n module-app deployment/kernel-mod-app -- lsmod | grep hello

# Verify the SYS_MODULE capability is present
oc exec -n module-app deployment/kernel-mod-app -- cat /proc/self/status | grep CapEff
----

== Lab Summary

This lab demonstrated essential SCC troubleshooting skills for applications requiring elevated privileges:

* **Problem Identification**: Recognized kernel module loading failures due to insufficient capabilities
* **SCC Analysis**: Understood the relationship between SCCs, capabilities, and security contexts
* **Custom SCC Creation**: Created a targeted SCC with specific capabilities instead of using privileged access
* **ServiceAccount Management**: Properly bound ServiceAccounts to custom SCCs
* **Security Evaluation**: Analyzed security implications and alternative approaches

== Additional Resources

* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/authentication_and_authorization/managing-security-context-constraints#security-context-constraints-command-reference_configuring-internal-oauth[SCC Command Reference]
* link:https://kubernetes.io/docs/tasks/configure-pod-container/security-context/[Configure Security Context for Pod]
* link:https://man7.org/linux/man-pages/man7/capabilities.7.html[Linux Capabilities Manual]
* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/authentication_and_authorization/understanding-and-creating-service-accounts[ServiceAccount Documentation]
