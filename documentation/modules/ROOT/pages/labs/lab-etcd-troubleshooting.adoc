= OpenShift Control Plane - ETCD Troubleshooting
include::../_attributes.adoc[]

:imagesdir: assets/images

== Lab Overview

This lab focuses on troubleshooting etcd cluster issues in OpenShift, covering scenarios where etcd components fail or become unavailable. You'll learn to diagnose etcd-related problems, understand the impact on cluster operations, and apply appropriate remediation techniques to restore etcd functionality.

=== Learning Objectives

By completing this lab, you will be able to:

* Understand etcd's role in OpenShift cluster operations
* Diagnose etcd cluster health and connectivity issues
* Identify etcd static pod failures and port conflicts
* Use etcd debugging tools and commands effectively
* Restore etcd functionality after service disruptions
* Analyze cluster operator degradation related to etcd issues

=== Reference Documentation

* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/backup_and_restore/troubleshooting-backup-and-restore[Troubleshooting backup and restore]
* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/backup_and_restore/control_plane_backup_and_restore[Control plane backup and restore]
* link:https://etcd.io/docs/v3.5/op-guide/maintenance/[etcd Maintenance Guide]

== etcd Troubleshooting Commands

When troubleshooting etcd cluster issues, use these commands to investigate and resolve problems:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Check etcd cluster operator status
oc get clusteroperator etcd
oc describe clusteroperator etcd

# View etcd static pods
oc get pods -n openshift-etcd | grep etcd
oc get pods -n openshift-etcd -o wide

# Check etcd endpoints and member status
oc get endpoints -n openshift-etcd etcd
oc describe configmap etcd-endpoints -n openshift-etcd

# Check etcd member list and cluster health
NODE=$(oc get nodes -l node-role.kubernetes.io/master -o name | head -1 | cut -d'/' -f2)
oc rsh -n openshift-etcd etcd-$NODE etcdctl member list -w table
oc rsh -n openshift-etcd etcd-$NODE etcdctl endpoint health --cluster

# Check etcd operator logs
oc logs -n openshift-etcd-operator deployment/etcd-operator --tail=50

# Check etcd static pod logs
oc logs -n openshift-etcd etcd-$NODE --tail=50
oc logs -n openshift-etcd etcd-$NODE --previous || echo "No previous logs available"

# Check for port conflicts on control plane nodes
oc debug node/$NODE -- chroot /host netstat -tulpn | grep 2379
oc debug node/$NODE -- chroot /host ss -tlnp | grep 2379

# Check etcd data directory and permissions
oc debug node/$NODE -- chroot /host ls -la /var/lib/etcd/

# Look for etcd process conflicts
oc debug node/$NODE -- chroot /host ps aux | grep etcd

# Check cluster events for etcd-related issues
oc get events --sort-by='.lastTimestamp' | grep -i "etcd\|machineconfig"

# Monitor etcd cluster operator status
oc get co etcd -w
----

== Understanding etcd in OpenShift

etcd is the key-value store that backs OpenShift's control plane, storing cluster configuration, API objects, cluster state, authentication data, and operational information. OpenShift deploys etcd as static pods on control plane nodes.

[IMPORTANT]
====
**etcd Quorum Requirements**:
- 3-node cluster: Tolerates 1 node failure (quorum = 2)
- Loss of quorum results in cluster read-only mode or complete failure
====

== Exercise 1: Understanding Normal etcd Operations

=== Information Gathering: Baseline etcd Health

Before introducing problems, establish baseline etcd health:

[source,bash]
----
# Check overall cluster operator status
oc get co etcd

# Examine etcd operator detailed status
oc describe co etcd

# List all etcd-related pods
oc get pods -n openshift-etcd -o wide

# Check etcd member status
oc rsh -n openshift-etcd etcd-$(oc get nodes -l node-role.kubernetes.io/master -o name | head -1 | cut -d'/' -f2) etcdctl member list -w table

# Verify etcd connectivity
oc rsh -n openshift-etcd etcd-$(oc get nodes -l node-role.kubernetes.io/master -o name | head -1 | cut -d'/' -f2) etcdctl endpoint health
----

== Exercise 2: Troubleshooting etcd Cluster Issues

=== Scenario Setup: Control Plane Service Disruption

Navigate to the etcd troubleshooting lab directory and deploy the exercise scenario:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Change to the etcd troubleshooting lab directory
cd /home(demo-user/troubleshooting-lab/lab-materials/06-etcd

# Deploy the exercise scenario
oc apply -k .

# Monitor cluster operator status immediately
watch oc get co etcd
----

[WARNING]
====
**Lab Safety Notice**: This lab deliberately creates a critical cluster issue. Only perform this in a dedicated lab environment, never in production or shared development clusters.
====

=== Investigation Challenge

**YOUR MISSION**: Investigate the cluster behavior and identify any issues.

**What to check:**

- What is the status of the etcd cluster operator?
- Are there any etcd pods failing or in error state?
- Which control plane nodes are affected?
- What pods are running on the control plane nodes?
- Are there any port conflicts or network issues?

Use the troubleshooting commands provided earlier to investigate the cluster behavior systematically.

== Exercise 3: Resolving etcd Cluster Issues

=== Understanding the Problem

If you discovered that the etcd cluster operator is degraded and etcd pods are failing, this indicates a critical control plane issue that needs immediate attention.

=== Creating the Solution

**YOUR MISSION**: Identify and resolve the etcd cluster issue to restore cluster functionality.

**Steps to complete:**

1. **Identify the root cause** of the etcd failure
2. **Locate the affected control plane node**
3. **Remove the source of the disruption**
4. **Restart etcd services** to restore functionality
5. **Verify cluster recovery**

.Click to reveal the solution
[%collapsible]
====
**Solution Implementation:**

Apply the fix to restore etcd functionality:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Execute the fix script
oc apply -k solution/

# Alternative manual steps:
# 1. Delete the disruptive pod
oc delete pod break-etcd -n default

# 2. If etcd static pods are stuck, force delete them
AFFECTED_NODE=$(oc get nodes -l node-role.kubernetes.io/master -o name | head -1 | cut -d'/' -f2)
oc delete pod -n openshift-etcd etcd-$AFFECTED_NODE --force --grace-period=0

# 3. If etcd-guard pod exists and is problematic, remove it
oc delete pod -n openshift-etcd etcd-guard-$AFFECTED_NODE --force --grace-period=0 || echo "No etcd-guard pod to delete"
----
====

=== Verification

Monitor the etcd recovery process:

[.lines_space]
[.console-input]
[source,bash, subs="+macros,+attributes"]
----
# Watch etcd cluster operator status during recovery
watch oc get co etcd

# Monitor etcd pod restart
oc get pods -n openshift-etcd -w

# Check when all etcd pods are running
oc get pods -n openshift-etcd | grep etcd-

# Verify etcd cluster health after recovery
sleep 60  # Wait for pods to stabilize
NODE=$(oc get nodes -l node-role.kubernetes.io/master -o name | head -1 | cut -d'/' -f2)
oc rsh -n openshift-etcd etcd-$NODE etcdctl endpoint health --cluster

# Verify etcd member list
oc rsh -n openshift-etcd etcd-$NODE etcdctl member list -w table
----

== Lab Summary

This lab demonstrated critical etcd troubleshooting skills for OpenShift control plane management:

* **Service Disruption**: Simulated realistic etcd service failure through port conflicts
* **Impact Analysis**: Observed how etcd issues affect cluster operator status and functionality
* **Systematic Diagnosis**: Applied structured troubleshooting methodology to identify root causes
* **Recovery Procedures**: Restored etcd functionality through proper cleanup and restart procedures
* **Health Monitoring**: Implemented ongoing monitoring techniques for etcd cluster health

== Additional Resources

* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/backup_and_restore/control_plane_backup_and_restore[etcd Backup and Restore]
* link:https://etcd.io/docs/v3.5/op-guide/recovery/[etcd Disaster Recovery]
* link:https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/support/troubleshooting-operating-system-issues#troubleshooting-etcd-issues_troubleshooting-operating-system-issues[Troubleshooting etcd Issues]
* link:https://etcd.io/docs/v3.5/op-guide/monitoring/[etcd Monitoring Guide]
